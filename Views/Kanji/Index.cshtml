@model Denkiishi_v2.Models.KanjiGeralViewModel

<div class="modal fade" id="modalTraducao" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="modalConteudoDinamico"></div>
    </div>
</div>

<div class="modal fade" id="modalSucesso" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content text-center border-0 shadow-lg">
            <div class="modal-body p-4">
                <div class="mb-3"><i class="fa fa-check-circle text-success" style="font-size: 4rem;"></i></div>
                <h4 class="fw-bold text-success mb-3">Sucesso!</h4>
                <p class="lead fs-6 text-muted mb-4" id="txtMensagemSucesso">...</p>
                <button type="button" class="btn btn-success w-100 rounded-pill" data-bs-dismiss="modal">Legal! (Enter)</button>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <div class="row align-items-center mb-4 border-bottom pb-3">
        <div class="col-md-4">
            <h2 class="text-primary m-0"><i class="fa fa-font"></i> Mapa de Kanjis</h2>
        </div>
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="fa fa-search text-muted"></i></span>
                <input type="text" id="inputBusca" class="form-control border-start-0" placeholder="Buscar Kanji, leitura ou significado..." spellcheck="true" lang="pt-BR" onkeyup="filtrarKanjis()">
            </div>
        </div>
        <div class="col-md-4 text-end mt-2 mt-md-0">
            <form asp-action="Index" method="get" class="d-inline-flex align-items-center">
                <label class="me-2 fw-bold small">Verificar em:</label>
                <select name="linguaId" asp-items="Model.LinguasDisponiveis" class="form-select w-auto" onchange="this.form.submit()"></select>
            </form>
        </div>
    </div>

    @foreach (var nivel in Model.KanjisPorNivel)
    {
        string nomeNivel = nivel.Key == "0" ? "Outros" : $"JLPT {nivel.Key}";
        int total = nivel.Value.Count;
        int traduzidos = nivel.Value.Count(k => k.TemTraducao);
        int porcentagem = total > 0 ? (int)((double)traduzidos / total * 100) : 0;
        string corBarra = porcentagem < 10 ? "bg-danger" : (porcentagem < 30 ? "bg-warning" : "bg-success");

        <div class="card mb-4 shadow-sm kanji-section">
            <div class="card-header bg-dark text-white pb-3">
                <div class="d-flex justify-content-between align-items-end mb-2">
                    <div class="d-flex align-items-center gap-2">
                        <h4 class="m-0 fw-bold">@nomeNivel</h4>
                        <span class="badge bg-secondary rounded-pill small">@total kanjis</span>
                    </div>
                    <div class="text-end">
                        <span class="fw-bold text-white fs-5 js-pct">@porcentagem%</span>
                        <div class="small text-white-50 js-count">@traduzidos / @total</div>
                    </div>
                </div>
                <div class="progress bg-secondary bg-opacity-25" style="height: 10px; border-radius: 10px;">
                    <div class="progress-bar @corBarra progress-bar-striped progress-bar-animated js-bar" role="progressbar" style="width: @porcentagem%; transition: width 1s ease;" aria-valuenow="@porcentagem" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var kanji in nivel.Value)
                    {
                        string classeBotao = kanji.TemTraducao ? "btn-success" : "btn-outline-secondary";
                        <button id="btn-kanji-@kanji.Id" onclick="abrirModal(@kanji.Id)" class="btn @classeBotao d-flex justify-content-center align-items-center fw-bold fs-5 shadow-sm kanji-btn" style="width: 50px; height: 50px;" title="@(kanji.TemTraducao ? "Traduzido" : "Pendente")" data-search="@kanji.SearchText">
                            @kanji.Literal
                        </button>
                    }
                </div>
            </div>
        </div>
    }
</div>

<style>
    /* Estilos das Animações */
    @@keyframes shake {
        0%, 100% {
            transform: translateX(0);
        }

        10%, 30%, 50%, 70%, 90% {
            transform: translateX(-5px);
        }

        20%, 40%, 60%, 80% {
            transform: translateX(5px);
        }
    }

    .shake-effect {
        animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        border: 3px solid #dc3545 !important;
        box-shadow: 0 0 15px rgba(220, 53, 69, 0.6) !important;
    }

    @@keyframes jump-success {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0);
        }

        40% {
            transform: translateY(-20px);
        }

        60% {
            transform: translateY(-10px);
        }
    }

    .success-effect {
        border: 4px solid #198754 !important;
        box-shadow: 0 0 40px rgba(25, 135, 84, 0.9) !important;
        animation: jump-success 1s ease;
    }

    .hover-white:hover {
        color: white !important;
    }

    .hover-delete {
        transition: transform 0.2s;
        opacity: 0.8;
    }

        .hover-delete:hover {
            transform: scale(1.4);
            opacity: 1;
        }

    /* --- NOVOS ESTILOS PARA O SLIDE (EDITOR DE HISTÓRIAS) --- */
    .modal-slider-container {
        overflow: hidden;
        width: 100%;
        position: relative;
    }

    .modal-slider-wrapper {
        display: flex;
        width: 200%;
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .modal-slide {
        width: 50%;
        flex-shrink: 0;
    }

    .badge-clickable {
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .badge-clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

    .syntax-toolbar {
        background: #e9ecef;
        border: 1px solid #ced4da;
        border-bottom: none;
        padding: 5px;
        border-radius: 5px 5px 0 0;
        display: flex;
        gap: 5px;
    }

    .editor-textarea {
        border-radius: 0 0 5px 5px;
        resize: vertical;
        min-height: 120px;
    }

    .modal-slider-wrapper {
        display: flex;
        width: 300%; /* Aumentado para caber 3 telas */
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .modal-slide {
        width: 33.333%; /* Cada tela ocupa 1/3 */
        flex-shrink: 0;
    }
</style>

@section Scripts {
    <script>
        // --- 0. FUNÇÃO DE FALA ---
        function falarJapones(texto) {
            if (!texto) return;
            window.speechSynthesis.cancel();
            if ('speechSynthesis' in window) {
                const fala = new SpeechSynthesisUtterance(texto);
                fala.lang = 'ja-JP'; fala.rate = 0.8; fala.pitch = 1;
                window.speechSynthesis.speak(fala);
            }
        }

        // --- 1. VARIÁVEIS GLOBAIS ---
        let modalPalavras = [];

        // --- 2. BUSCA NA TELA ---
        function filtrarKanjis() {
            const termo = document.getElementById('inputBusca').value.toLowerCase().trim();
            const botoes = document.querySelectorAll('.kanji-btn');
            const secoes = document.querySelectorAll('.kanji-section');
            botoes.forEach(btn => {
                const keywords = btn.getAttribute('data-search');
                if (termo === "" || keywords.includes(termo)) { btn.classList.remove('d-none'); btn.classList.add('d-flex'); }
                else { btn.classList.add('d-none'); btn.classList.remove('d-flex'); }
            });
            secoes.forEach(sec => {
                const visiveis = sec.querySelectorAll('.kanji-btn:not(.d-none)').length;
                sec.style.display = visiveis > 0 ? 'block' : 'none';
            });
        }

        // --- 3. ABRIR MODAL (AJAX) ---
        async function abrirModal(id) {
            modalPalavras = [];
            const modalEl = document.getElementById('modalTraducao');
            let modal = bootstrap.Modal.getInstance(modalEl);
            if (!modal) modal = new bootstrap.Modal(modalEl);
            if (!modalEl.classList.contains('show')) modal.show();

            document.getElementById('modalConteudoDinamico').innerHTML = `<div class="modal-body text-center p-5"><div class="spinner-border text-primary"></div></div>`;

            try {
                // OBS: Certifique-se que o Controller retorna a Partial View correta
                const r = await fetch(`/Kanji/DetalhesModal/${id}?v=${new Date().getTime()}`);
                if (r.ok) {
                    document.getElementById('modalConteudoDinamico').innerHTML = await r.text();
                } else {
                    document.getElementById('modalConteudoDinamico').innerHTML = '<div class="p-3 text-danger">Erro ao carregar.</div>';
                }
            } catch (e) { console.error(e); }
        }

        // --- 4. FUNÇÕES DE TRADUÇÃO (ADD/REMOVE) ---
        function validarTextoEmTempoReal(input) {
            var texto = input.value;
            var msgErro = document.getElementById("msgErroModal");
            if (modalPalavras.some(p => p.texto.toLowerCase() === texto.toLowerCase())) {
                msgErro.innerText = "⚠️ Essa palavra já está na lista";
                msgErro.style.display = 'block';
            } else {
                msgErro.style.display = 'none';
            }
        }

        function modalAddPalavra() {
            const input = document.getElementById('modalInputPalavra');
            if (!input) return;
            const t = input.value.trim();
            if (!t) return;
            if (modalPalavras.some(p => p.texto.toLowerCase() === t.toLowerCase())) {
                const msgEl = document.getElementById('msgErroModal');
                if (msgEl) {
                    msgEl.innerText = "⚠️ Palavra já está na lista.";
                    msgEl.style.display = 'block';
                    setTimeout(() => msgEl.style.display = 'none', 3000);
                }
                return;
            }
            modalPalavras.push({ texto: t, principal: modalPalavras.length === 0 });
            input.value = ''; input.focus();
            modalRender();
        }

        function modalRender() {
            const c = document.getElementById('modalContainerChips');
            c.innerHTML = '';
            if (modalPalavras.length === 0) {
                c.innerHTML = '<span class="text-muted small w-100 text-center align-self-center fst-italic" id="msgVazio">Lista vazia...</span>'; return;
            }
            modalPalavras.forEach((item, i) => {
                const d = document.createElement('div');
                d.className = `badge ${item.principal ? 'bg-primary' : 'bg-secondary'} fs-6 rounded px-3 py-2 d-flex align-items-center gap-2 pointer`;
                d.style.cursor = 'pointer';
                d.onclick = () => { modalPalavras.forEach((p, idx) => p.principal = (idx === i)); modalRender(); };
                d.innerHTML = `<span>${item.texto}${item.principal ? ' <i class="fa fa-star text-warning"></i>' : ''}</span> <span onclick="event.stopPropagation(); modalPalavras.splice(${i},1); modalRender();" class="ms-2 fw-bold text-white-50 hover-white" style="cursor:pointer;">&times;</span>`;
                c.appendChild(d);
            });
        }

        async function modalSalvar() {
            const msgEl = document.getElementById('msgErroModal');
            if (msgEl) msgEl.style.display = 'none';
            if (modalPalavras.length === 0) {
                if (msgEl) { msgEl.innerText = "⚠️ Adicione ao menos uma palavra."; msgEl.style.display = 'block'; }
                return;
            }
            const btn = document.getElementById('btnModalSalvar');
            const originalText = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Salvando...';
            const kId = document.getElementById('modalKanjiId').value;
            const lId = document.getElementById('modalComboLingua').value;
            const payload = { KanjiId: parseInt(kId), LinguaId: parseInt(lId), Palavras: modalPalavras.map(p => ({ Texto: p.texto, EhPrincipal: p.principal })) };

            try {
                const res = await fetch('/Kanji/SalvarTraducoes', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (res.ok) {
                    const data = await res.json();
                    bootstrap.Modal.getInstance(document.getElementById('modalTraducao')).hide();
                    const b = document.getElementById('btn-kanji-' + kId);
                    if (b) {
                        b.classList.remove('btn-outline-secondary'); b.classList.add('btn-success'); b.title = "Traduzido";
                        b.style.transition = "transform 0.3s"; b.style.transform = "scale(1.3)"; setTimeout(() => b.style.transform = "scale(1)", 500);
                        const secaoPai = b.closest('.kanji-section');
                        if (secaoPai) atualizarBarraProgresso(secaoPai);
                    }
                    document.getElementById('txtMensagemSucesso').innerText = data.mensagem;
                    const ms = new bootstrap.Modal(document.getElementById('modalSucesso')); ms.show();
                    setTimeout(() => { ms.hide(); }, 1000);
                } else {
                    const erroTxt = await res.text();
                    const modalContent = document.querySelector('#modalTraducao .modal-content');
                    modalContent.classList.add('shake-effect'); setTimeout(() => modalContent.classList.remove('shake-effect'), 500);
                    if (msgEl) { msgEl.innerText = "⚠️ " + erroTxt; msgEl.style.display = 'block'; setTimeout(() => msgEl.style.display = 'none', 4000); }
                }
            } catch (e) { console.error(e); }
            finally { if (document.body.classList.contains('modal-open')) { btn.disabled = false; btn.innerHTML = originalText; } }
        }

        function modalExcluirTraducao(idTraducao) {
            document.getElementById('footerBtnDefault').style.display = 'none';
            document.getElementById('footerBtnConfirm').style.display = 'flex';
            const btnSim = document.getElementById('btnConfirmarExclusao');
            btnSim.onclick = () => executarExclusao(idTraducao);
        }

        function cancelarExclusao() {
            document.getElementById('footerBtnConfirm').style.display = 'none';
            document.getElementById('footerBtnDefault').style.display = 'flex';
        }

        async function executarExclusao(idTraducao) {
            const btnSim = document.getElementById('btnConfirmarExclusao');
            const originalHtml = btnSim.innerHTML;
            btnSim.disabled = true; btnSim.innerHTML = '<i class="fa fa-spinner fa-spin"></i> ...';
            try {
                const response = await fetch(`/Kanji/ExcluirTraducao?id=${idTraducao}`, { method: 'POST' });
                if (response.ok) {
                    const data = await response.json();
                    const kId = data.id || document.getElementById('modalKanjiId').value;
                    const btnPrincipal = document.getElementById('btn-kanji-' + kId);
                    if (btnPrincipal) {
                        if (data.temMais === false) { btnPrincipal.classList.remove('btn-success'); btnPrincipal.classList.add('btn-outline-secondary'); btnPrincipal.title = "Pendente"; }
                        else { btnPrincipal.classList.remove('btn-outline-secondary'); btnPrincipal.classList.add('btn-success'); btnPrincipal.title = "Traduzido"; }
                        const secaoPai = btnPrincipal.closest('.kanji-section');
                        if (secaoPai) atualizarBarraProgresso(secaoPai);
                    }
                    document.getElementById('footerBtnConfirm').style.display = 'none';
                    const msgEl = document.getElementById('msgErroModal');
                    if (msgEl) { msgEl.className = "text-success fw-bold small me-auto"; msgEl.innerText = "✅ Removido!"; msgEl.style.display = "block"; }
                    const modalContent = document.querySelector('#modalTraducao .modal-content');
                    modalContent.classList.add('success-effect');
                    setTimeout(() => { modalContent.classList.remove('success-effect'); abrirModal(kId); }, 1500);
                } else {
                    const erroTxt = await response.text();
                    alert("Erro: " + erroTxt);
                    btnSim.disabled = false; btnSim.innerHTML = originalHtml;
                }
            } catch (e) {
                console.error(e);
                btnSim.disabled = false; btnSim.innerHTML = originalHtml;
            }
        }

        function atualizarBarraProgresso(sectionElement) {
            if (!sectionElement) return;
            const total = sectionElement.querySelectorAll('.kanji-btn').length;
            const traduzidos = sectionElement.querySelectorAll('.kanji-btn.btn-success').length;
            const pct = total > 0 ? Math.floor((traduzidos / total) * 100) : 0;
            const txtPct = sectionElement.querySelector('.js-pct');
            const txtCont = sectionElement.querySelector('.js-count');
            const bar = sectionElement.querySelector('.js-bar');
            if (txtPct) txtPct.innerText = pct + "%";
            if (txtCont) txtCont.innerText = traduzidos + " / " + total;
            if (bar) {
                bar.style.width = pct + "%"; bar.setAttribute('aria-valuenow', pct);
                bar.className = "progress-bar progress-bar-striped progress-bar-animated js-bar";
                if (pct < 10) bar.classList.add("bg-danger"); else if (pct < 30) bar.classList.add("bg-warning"); else bar.classList.add("bg-success");
            }
        }

        // ==========================================
        // 8. LÓGICA DO EDITOR DE HISTÓRIAS (NOVO - SyntaxHighlight)
        // ==========================================

                    // Note o 'async' aqui no começo da função
        async function abrirEditorHistoria(idMeaning, texto, lingua, temHistoria) {

            // 1. Configura Cabeçalho e IDs
            document.getElementById('lblEditorTitulo').innerText = texto;
            document.getElementById('lblEditorLingua').innerText = lingua;
            document.getElementById('editorMeaningId').value = idMeaning;

            // 2. Esconde Footer
            const footer = document.getElementById('modalFooterPadrao');
            if(footer) {
                footer.classList.remove('d-flex');
                footer.classList.add('d-none');
            }

            // 3. Efeito Visual: Limpa e mostra "Carregando..."
            const txtArea = document.getElementById('txtEditorHistoria');
            txtArea.value = "Carregando...";

            // Inicia o Slide imediatamente (para a UI ser rápida)
            document.getElementById('sliderWrapper').style.transform = "translateX(-33.333%)";

            // 4. Lógica de Carregamento (O Pulo do Gato 🐈)
            if(temHistoria) {
                try {
                    // Chama o Controller para pegar o texto real
                    const response = await fetch(`/Kanji/GetHistoria?meaningId=${idMeaning}`);

                    if (response.ok) {
                        const data = await response.json();
                        txtArea.value = data.texto; // Preenche com a história do banco
                    } else {
                        txtArea.value = "Erro ao carregar história.";
                    }
                } catch (error) {
                    console.error("Erro de conexão:", error);
                    txtArea.value = "Erro de conexão.";
                }
            } else {
                // Se não tem história, limpa o campo para começar do zero
                txtArea.value = "";
            }

            // 5. Atualiza o Preview (cores) com o texto que acabou de chegar
            setTimeout(atualizarPreviewEditor, 100);
        }

        function voltarParaDetalhes() {
            // 1. Volta o slide
            document.getElementById('sliderWrapper').style.transform = "translateX(0)";

            // 2. MOSTRA O FOOTER DE VOLTA
            setTimeout(() => {
                const footer = document.getElementById('modalFooterPadrao');
                if(footer) {
                    footer.classList.remove('d-none'); // Remove o hidden
                    footer.classList.add('d-flex');    // Volta o flex original
                }
            }, 300); // Espera a animação quase acabar
        }

        function inserirTagEditor(tag) {
            const txtArea = document.getElementById('txtEditorHistoria');
            const start = txtArea.selectionStart;
            const end = txtArea.selectionEnd;
            const text = txtArea.value;
            const selection = text.substring(start, end);
            const content = selection.length > 0 ? selection : "texto";
            const tagFull = `<${tag}>${content}</${tag}>`;
            txtArea.value = text.substring(0, start) + tagFull + text.substring(end);
            txtArea.focus();
            atualizarPreviewEditor();
        }

            function atualizarPreviewEditor() {
            let raw = document.getElementById('txtEditorHistoria').value;

            // 1. Sanitização básica (Converte < para &lt; para evitar injeção de HTML malicioso)
            raw = raw.replace(/</g, '&lt;').replace(/>/g, '&gt;');

            // 2. Quebras de linha visual
            let formatted = raw.replace(/\n/g, '<br>');

            // 3. RECUPERAR REGRAS DO INPUT HIDDEN (CORREÇÃO DO AJAX)
            let regras = [];
            const inputRegras = document.getElementById('dadosSyntaxHighlight');

            if (inputRegras && inputRegras.value) {
                try {
                    regras = JSON.parse(inputRegras.value);
                } catch (e) {
                    console.error("Erro ao converter regras de syntax:", e);
                }
            }

            // 4. Aplicação Dinâmica das Regras
            if (regras && Array.isArray(regras)) {
                regras.forEach(rule => {
                    // Monta o estilo CSS
                    let style = "";
                    if (rule.textColor) style += `color:${rule.textColor};`;
                    if (rule.bgColor) style += `background-color:${rule.bgColor}; padding: 0 2px; border-radius: 3px;`;
                    if (rule.bold) style += "font-weight:bold;";
                    if (rule.italic) style += "font-style:italic;";
                    if (rule.underline) style += "text-decoration:underline;";

                    // Regex: Busca por &lt;codigo&gt;texto&lt;/codigo&gt;
                    // O 'g' significa global (todas as ocorrências) e 'i' case-insensitive (opcional)
                    const regex = new RegExp(`&lt;${rule.code}&gt;(.*?)&lt;/${rule.code}&gt;`, 'g');

                    // Substitui a tag customizada por um SPAN com estilo real
                    formatted = formatted.replace(regex, `<span style="${style}">$1</span>`);
                });
            }

            // 5. Injeta no Preview
            const divPreview = document.getElementById('divEditorPreview');
            if(divPreview) divPreview.innerHTML = formatted;
        }
            async function salvarHistoriaBackend() {
            // 1. Captura os dados da tela
            const id = document.getElementById('editorMeaningId').value;
            const texto = document.getElementById('txtEditorHistoria').value;

            // Captura o botão para efeitos visuais
            const btn = event.target; // O botão que foi clicado
            const originalHtml = btn.innerHTML; // Guarda o texto original ("Salvar")

            // 2. Trava o botão e mostra Loading
            btn.disabled = true;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Salvando...';

            // 3. Prepara o pacote JSON
            const payload = {
                MeaningId: parseInt(id),
                Texto: texto
            };

            try {
                // 4. Envia para o servidor
                const response = await fetch('/Kanji/SalvarHistoriaMeaning', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Se estiver usando Anti-Forgery Token do ASP.NET Core, descomente a linha abaixo:
                        // 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    // === SUCESSO ===
                    const data = await response.json(); // Se quiser ler a mensagem do servidor

                    // Feedback Visual Verde
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-dark'); // Fica escuro/concluído
                    btn.innerHTML = '<i class="fa fa-check"></i> Salvo!';

                    // Atualiza a UI da Badge na lista (opcional, mas chique)
                    // Procura a badge que clicamos e adiciona o ícone de livro se não tiver
                    atualizarBadgeNaLista(id);

                    // Espera 1 segundo e volta para a lista de detalhes
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalHtml;
                        btn.classList.add('btn-success');
                        btn.classList.remove('btn-dark');

                        voltarParaDetalhes(); // Fecha o slide do editor
                    }, 1000);

                } else {
                    // === ERRO DO SERVIDOR ===
                    const erroTxt = await response.text();
                    alert("Erro ao salvar: " + erroTxt);
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }

            } catch (e) {
                // === ERRO DE REDE ===
                console.error(e);
                alert("Erro de comunicação com o servidor.");
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        // Função auxiliar para atualizar a badge visualmente sem recarregar a tela
        function atualizarBadgeNaLista(meaningId) {
            // Procura todos os onclicks para achar o que tem o ID certo
            // Nota: Isso é uma busca aproximada baseada no HTML gerado
            const badges = document.querySelectorAll('.badge-clickable');
            badges.forEach(b => {
                if(b.onclick && b.onclick.toString().includes(meaningId)) {
                    // Verifica se já tem o ícone de livro
                    if(!b.innerHTML.includes('fa-book-open')) {
                        // Adiciona o ícone visualmente para o usuário saber que já tem história
                        const icon = document.createElement('i');
                        icon.className = 'fa fa-book-open text-info ms-1';
                        icon.title = 'Tem História';
                        // Insere antes do botão de fechar (x)
                        const btnClose = b.querySelector('.hover-delete');
                        if(btnClose) {
                            b.insertBefore(icon, btnClose);
                        } else {
                            b.appendChild(icon);
                        }

                        // Atualiza o onclick para passar "true" (TemHistoria) na próxima vez
                        // Isso é meio "hacky" via string replace, mas funciona para evitar reload
                        // O ideal seria recarregar o modal, mas é mais lento.
                    }
                }
            });
        }

                // --- LÓGICA DO READING ---

             function abrirPainelReadings() {
            const footer = document.getElementById('modalFooterPadrao');
            if(footer) { footer.classList.remove('d-flex'); footer.classList.add('d-none'); }

            // -66.666% mostra o terceiro slide
            document.getElementById('sliderWrapper').style.transform = "translateX(-66.666%)";
        }

        // Adapte a função voltarParaDetalhes para resetar para 0
        // Nota: Se a função antiga setava 'translateX(0)', continua funcionando.

              async function selecionarReading(id, type, kana, temHistoria, isPrincipal) {
            // 1. Setup UI
            document.getElementById('msgSelecioneReading').style.display = 'none';
            document.getElementById('areaEdicaoReading').style.display = 'block';

            document.getElementById('lblReadingSelecionado').innerText = kana;
            document.getElementById('lblReadingType').innerText = type;
            document.getElementById('hdnReadingId').value = id;

            // Controle do botão Excluir
            const btnExcluir = document.getElementById('btnExcluirReading');
            btnExcluir.style.display = temHistoria ? 'block' : 'none';

            // 2. Carregar Texto
            const txt = document.getElementById('txtEditorReading');
            txt.value = "Carregando...";

            if (temHistoria) {
                try {
                    const res = await fetch(`/Kanji/GetHistoriaReading?readingId=${id}`);
                    if (res.ok) {
                        const data = await res.json();
                        txt.value = data.texto;
                    } else {
                        txt.value = "Erro ao carregar.";
                    }
                } catch { txt.value = "Erro de conexão."; }
            } else {
                txt.value = "";
            }

            atualizarPreviewReading();
        }

               // --- FUNÇÃO CORRIGIDA: INSERIR TAG NO READING ---
        function inserirTagReading(tag) {
            const txtArea = document.getElementById('txtEditorReading');

            // 1. Captura posições
            const start = txtArea.selectionStart;
            const end = txtArea.selectionEnd;
            const text = txtArea.value;
            const selection = text.substring(start, end);

            // 2. Define conteúdo (mantém seleção ou usa "texto")
            const hasSelection = selection.length > 0;
            const content = hasSelection ? selection : "texto";

            // 3. Monta a tag
            const tagOpen = `<${tag}>`;
            const tagClose = `</${tag}>`;
            const tagFull = tagOpen + content + tagClose;

            // 4. Insere no texto
            txtArea.value = text.substring(0, start) + tagFull + text.substring(end);

            // 5. Ajusta cursor
            if (hasSelection) {
                const newCursorPos = start + tagFull.length;
                txtArea.setSelectionRange(newCursorPos, newCursorPos);
            } else {
                txtArea.setSelectionRange(start + tagOpen.length, start + tagOpen.length + content.length);
            }

            txtArea.focus();
            atualizarPreviewReading();
        }

        // --- FUNÇÃO CORRIGIDA: ATUALIZAR PREVIEW DO READING ---
        function atualizarPreviewReading() {
            // A. Pega o texto do editor de READING
            const txtArea = document.getElementById('txtEditorReading');
            if (!txtArea) return; // Segurança caso a tela não tenha carregado

            let raw = txtArea.value;

            // B. Sanitização (Converte < para &lt;)
            raw = raw.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            let formatted = raw.replace(/\n/g, '<br>');

            // C. Recupera as regras do input hidden (O mesmo usado pelo Meaning)
            let regras = [];
            const inputRegras = document.getElementById('dadosSyntaxHighlight');

            if (inputRegras && inputRegras.value) {
                try {
                    regras = JSON.parse(inputRegras.value);
                } catch (e) {
                    console.error("Erro ao ler regras de syntax:", e);
                }
            }

            // D. Aplica as regras (cores, negrito, etc)
            if (regras && Array.isArray(regras)) {
                regras.forEach(rule => {
                    let style = "";
                    if (rule.textColor) style += `color:${rule.textColor};`;
                    if (rule.bgColor) style += `background-color:${rule.bgColor}; padding: 0 2px; border-radius: 3px;`;
                    if (rule.bold) style += "font-weight:bold;";
                    if (rule.italic) style += "font-style:italic;";
                    if (rule.underline) style += "text-decoration:underline;";

                    const regex = new RegExp(`&lt;${rule.code}&gt;(.*?)&lt;/${rule.code}&gt;`, 'g');
                    formatted = formatted.replace(regex, `<span style="${style}">$1</span>`);
                });
            }

            // E. Joga no preview de READING
            const divPreview = document.getElementById('divPreviewReading');
            if(divPreview) divPreview.innerHTML = formatted;
        }

               async function salvarReadingBackend() {
            const id = document.getElementById('hdnReadingId').value;
            const texto = document.getElementById('txtEditorReading').value;
            const btn = document.getElementById('btnSalvarReading');
            const originalHtml = btn.innerHTML;

            btn.disabled = true; btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Salvando...';

            const payload = { ReadingId: parseInt(id), Texto: texto };

            try {
                const res = await fetch('/Kanji/SalvarHistoriaReading', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    // === ATUALIZAÇÃO VISUAL DA LISTA (DOM) ===

                    // 1. Atualizar Estrela (Principal)
                    // Remove de todos
                    document.querySelectorAll('#listaReadings .icon-star').forEach(el => el.style.display = 'none');
                    // Adiciona no atual
                    const btnItem = document.getElementById('btn-reading-' + id);
                    if(btnItem) {
                        const star = btnItem.querySelector('.icon-star');
                        if(star) star.style.display = 'block';

                        // 2. Atualizar Livro (Tem História)
                        const book = btnItem.querySelector('.icon-book');
                        if(book) book.style.display = 'block';

                        // 3. Atualizar o onclick do botão para saber que agora tem história
                        // Isso evita ter que recarregar para poder excluir depois
                        // Regex substitui o 4º argumento (temHistoria) de false para true
                        let onclickAttr = btnItem.getAttribute('onclick');
                        // Truque simples: substitui ", false," por ", true," se existir
                        onclickAttr = onclickAttr.replace(', false,', ', true,');
                        btnItem.setAttribute('onclick', onclickAttr);
                    }

                    // Mostra o botão excluir agora que salvou
                    document.getElementById('btnExcluirReading').style.display = 'block';

                    // Feedback botão
                    btn.innerHTML = '<i class="fa fa-check"></i> Salvo!';
                    btn.classList.remove('btn-success'); btn.classList.add('btn-dark');
                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        btn.classList.add('btn-success'); btn.classList.remove('btn-dark');
                    }, 1500);

                } else {
                    alert("Erro ao salvar.");
                    btn.disabled = false; btn.innerHTML = originalHtml;
                }
            } catch (e) {
                console.error(e);
                btn.disabled = false; btn.innerHTML = originalHtml;
            }
        }
                async function excluirHistoriaReading() {
            if(!confirm("Tem certeza que deseja remover esta história?")) return;

            const id = document.getElementById('hdnReadingId').value;
            const btn = document.getElementById('btnExcluirReading');

            try {
                const res = await fetch(`/Kanji/ExcluirHistoriaReading?readingId=${id}`, { method: 'POST' });

                if(res.ok) {
                    // Limpa o editor
                    document.getElementById('txtEditorReading').value = "";
                    atualizarPreviewReading();

                    // Esconde botão excluir
                    btn.style.display = 'none';

                    // Atualiza visualmente a lista (Remove o livro)
                    const btnItem = document.getElementById('btn-reading-' + id);
                    if(btnItem) {
                        const book = btnItem.querySelector('.icon-book');
                        if(book) book.style.display = 'none';

                        // Atualiza onclick para false
                        let onclickAttr = btnItem.getAttribute('onclick');
                        // Regex mais segura para trocar 'true' por 'false' na posição do temHistoria
                        // Mas o replace simples costuma bastar se a ordem for mantida
                        onclickAttr = onclickAttr.replace(', true,', ', false,');
                        btnItem.setAttribute('onclick', onclickAttr);
                    }

                    alert("História removida!");
                } else {
                    alert("Erro ao excluir.");
                }
            } catch(e) { console.error(e); }
        }
    </script>
}