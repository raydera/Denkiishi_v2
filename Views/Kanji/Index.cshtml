@model Denkiishi_v2.Models.KanjiGeralViewModel

<div class="modal fade" id="modalTraducao" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="modalConteudoDinamico"></div>
    </div>
</div>

<div class="modal fade" id="modalSucesso" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content text-center border-0 shadow-lg">
            <div class="modal-body p-4">
                <div class="mb-3"><i class="fa fa-check-circle text-success" style="font-size: 4rem;"></i></div>
                <h4 class="fw-bold text-success mb-3">Sucesso!</h4>
                <p class="lead fs-6 text-muted mb-4" id="txtMensagemSucesso">...</p>
                <button type="button" class="btn btn-success w-100 rounded-pill" data-bs-dismiss="modal">Legal! (Enter)</button>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <div class="row align-items-center mb-4 border-bottom pb-3">
        <div class="col-md-4">
            <h2 class="text-primary m-0"><i class="fa fa-font"></i> Mapa de Kanjis</h2>
        </div>
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="fa fa-search text-muted"></i></span>
                <input type="text" id="inputBusca" class="form-control border-start-0" placeholder="Buscar Kanji, leitura ou significado..." spellcheck="true" lang="pt-BR" onkeyup="filtrarKanjis()">
            </div>
        </div>
        <div class="col-md-4 text-end mt-2 mt-md-0">
            <form asp-action="Index" method="get" class="d-inline-flex align-items-center">
                <label class="me-2 fw-bold small">Verificar em:</label>
                <select name="linguaId" asp-items="Model.LinguasDisponiveis" class="form-select w-auto" onchange="this.form.submit()"></select>
            </form>
        </div>
    </div>

    @foreach (var nivel in Model.KanjisPorNivel)
    {
        string nomeNivel = nivel.Key == "0" ? "Outros" : $"JLPT {nivel.Key}";
        int total = nivel.Value.Count;
        int traduzidos = nivel.Value.Count(k => k.TemTraducao);
        int porcentagem = total > 0 ? (int)((double)traduzidos / total * 100) : 0;
        string corBarra = porcentagem < 10 ? "bg-danger" : (porcentagem < 30 ? "bg-warning" : "bg-success");

        <div class="card mb-4 shadow-sm kanji-section">
            <div class="card-header bg-dark text-white pb-3">
                <div class="d-flex justify-content-between align-items-end mb-2">
                    <div class="d-flex align-items-center gap-2">
                        <h4 class="m-0 fw-bold">@nomeNivel</h4>
                        <span class="badge bg-secondary rounded-pill small">@total kanjis</span>
                    </div>
                    <div class="text-end">
                        <span class="fw-bold text-white fs-5 js-pct">@porcentagem%</span>
                        <div class="small text-white-50 js-count">@traduzidos / @total</div>
                    </div>
                </div>
                <div class="progress bg-secondary bg-opacity-25" style="height: 10px; border-radius: 10px;">
                    <div class="progress-bar @corBarra progress-bar-striped progress-bar-animated js-bar" role="progressbar" style="width: @porcentagem%; transition: width 1s ease;" aria-valuenow="@porcentagem" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var kanji in nivel.Value)
                    {
                        string classeBotao = kanji.TemTraducao ? "btn-success" : "btn-outline-secondary";
                        <button id="btn-kanji-@kanji.Id" onclick="abrirModal(@kanji.Id)" class="btn @classeBotao d-flex justify-content-center align-items-center fw-bold fs-5 shadow-sm kanji-btn" style="width: 50px; height: 50px;" title="@(kanji.TemTraducao ? "Traduzido" : "Pendente")" data-search="@kanji.SearchText">
                            @kanji.Literal
                        </button>
                    }
                </div>
            </div>
        </div>
    }
</div>

<style>
    /* Estilos das Animações */
    @@keyframes shake {
        0%, 100% {
            transform: translateX(0);
        }

        10%, 30%, 50%, 70%, 90% {
            transform: translateX(-5px);
        }

        20%, 40%, 60%, 80% {
            transform: translateX(5px);
        }
    }

    .shake-effect {
        animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        border: 3px solid #dc3545 !important;
        box-shadow: 0 0 15px rgba(220, 53, 69, 0.6) !important;
    }

    @@keyframes jump-success {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0);
        }

        40% {
            transform: translateY(-20px);
        }

        60% {
            transform: translateY(-10px);
        }
    }

    .success-effect {
        border: 4px solid #198754 !important;
        box-shadow: 0 0 40px rgba(25, 135, 84, 0.9) !important;
        animation: jump-success 1s ease;
    }

    .hover-white:hover {
        color: white !important;
    }

    .hover-delete {
        transition: transform 0.2s;
        opacity: 0.8;
    }

        .hover-delete:hover {
            transform: scale(1.4);
            opacity: 1;
        }

    /* --- NOVOS ESTILOS PARA O SLIDE (EDITOR DE HISTÓRIAS) --- */
    .modal-slider-container {
        overflow: hidden;
        width: 100%;
        position: relative;
    }

    .modal-slider-wrapper {
        display: flex;
        width: 200%;
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .modal-slide {
        width: 50%;
        flex-shrink: 0;
    }

    .badge-clickable {
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .badge-clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

    .syntax-toolbar {
        background: #e9ecef;
        border: 1px solid #ced4da;
        border-bottom: none;
        padding: 5px;
        border-radius: 5px 5px 0 0;
        display: flex;
        gap: 5px;
    }

    .editor-textarea {
        border-radius: 0 0 5px 5px;
        resize: vertical;
        min-height: 120px;
    }
</style>

@section Scripts {
    <script>
        // --- 0. FUNÇÃO DE FALA ---
        function falarJapones(texto) {
            if (!texto) return;
            window.speechSynthesis.cancel();
            if ('speechSynthesis' in window) {
                const fala = new SpeechSynthesisUtterance(texto);
                fala.lang = 'ja-JP'; fala.rate = 0.8; fala.pitch = 1;
                window.speechSynthesis.speak(fala);
            }
        }

        // --- 1. VARIÁVEIS GLOBAIS ---
        let modalPalavras = [];

        // --- 2. BUSCA NA TELA ---
        function filtrarKanjis() {
            const termo = document.getElementById('inputBusca').value.toLowerCase().trim();
            const botoes = document.querySelectorAll('.kanji-btn');
            const secoes = document.querySelectorAll('.kanji-section');
            botoes.forEach(btn => {
                const keywords = btn.getAttribute('data-search');
                if (termo === "" || keywords.includes(termo)) { btn.classList.remove('d-none'); btn.classList.add('d-flex'); }
                else { btn.classList.add('d-none'); btn.classList.remove('d-flex'); }
            });
            secoes.forEach(sec => {
                const visiveis = sec.querySelectorAll('.kanji-btn:not(.d-none)').length;
                sec.style.display = visiveis > 0 ? 'block' : 'none';
            });
        }

        // --- 3. ABRIR MODAL (AJAX) ---
        async function abrirModal(id) {
            modalPalavras = [];
            const modalEl = document.getElementById('modalTraducao');
            let modal = bootstrap.Modal.getInstance(modalEl);
            if (!modal) modal = new bootstrap.Modal(modalEl);
            if (!modalEl.classList.contains('show')) modal.show();

            document.getElementById('modalConteudoDinamico').innerHTML = `<div class="modal-body text-center p-5"><div class="spinner-border text-primary"></div></div>`;

            try {
                // OBS: Certifique-se que o Controller retorna a Partial View correta
                const r = await fetch(`/Kanji/DetalhesModal/${id}?v=${new Date().getTime()}`);
                if (r.ok) {
                    document.getElementById('modalConteudoDinamico').innerHTML = await r.text();
                } else {
                    document.getElementById('modalConteudoDinamico').innerHTML = '<div class="p-3 text-danger">Erro ao carregar.</div>';
                }
            } catch (e) { console.error(e); }
        }

        // --- 4. FUNÇÕES DE TRADUÇÃO (ADD/REMOVE) ---
        function validarTextoEmTempoReal(input) {
            var texto = input.value;
            var msgErro = document.getElementById("msgErroModal");
            if (modalPalavras.some(p => p.texto.toLowerCase() === texto.toLowerCase())) {
                msgErro.innerText = "⚠️ Essa palavra já está na lista";
                msgErro.style.display = 'block';
            } else {
                msgErro.style.display = 'none';
            }
        }

        function modalAddPalavra() {
            const input = document.getElementById('modalInputPalavra');
            if (!input) return;
            const t = input.value.trim();
            if (!t) return;
            if (modalPalavras.some(p => p.texto.toLowerCase() === t.toLowerCase())) {
                const msgEl = document.getElementById('msgErroModal');
                if (msgEl) {
                    msgEl.innerText = "⚠️ Palavra já está na lista.";
                    msgEl.style.display = 'block';
                    setTimeout(() => msgEl.style.display = 'none', 3000);
                }
                return;
            }
            modalPalavras.push({ texto: t, principal: modalPalavras.length === 0 });
            input.value = ''; input.focus();
            modalRender();
        }

        function modalRender() {
            const c = document.getElementById('modalContainerChips');
            c.innerHTML = '';
            if (modalPalavras.length === 0) {
                c.innerHTML = '<span class="text-muted small w-100 text-center align-self-center fst-italic" id="msgVazio">Lista vazia...</span>'; return;
            }
            modalPalavras.forEach((item, i) => {
                const d = document.createElement('div');
                d.className = `badge ${item.principal ? 'bg-primary' : 'bg-secondary'} fs-6 rounded px-3 py-2 d-flex align-items-center gap-2 pointer`;
                d.style.cursor = 'pointer';
                d.onclick = () => { modalPalavras.forEach((p, idx) => p.principal = (idx === i)); modalRender(); };
                d.innerHTML = `<span>${item.texto}${item.principal ? ' <i class="fa fa-star text-warning"></i>' : ''}</span> <span onclick="event.stopPropagation(); modalPalavras.splice(${i},1); modalRender();" class="ms-2 fw-bold text-white-50 hover-white" style="cursor:pointer;">&times;</span>`;
                c.appendChild(d);
            });
        }

        async function modalSalvar() {
            const msgEl = document.getElementById('msgErroModal');
            if (msgEl) msgEl.style.display = 'none';
            if (modalPalavras.length === 0) {
                if (msgEl) { msgEl.innerText = "⚠️ Adicione ao menos uma palavra."; msgEl.style.display = 'block'; }
                return;
            }
            const btn = document.getElementById('btnModalSalvar');
            const originalText = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Salvando...';
            const kId = document.getElementById('modalKanjiId').value;
            const lId = document.getElementById('modalComboLingua').value;
            const payload = { KanjiId: parseInt(kId), LinguaId: parseInt(lId), Palavras: modalPalavras.map(p => ({ Texto: p.texto, EhPrincipal: p.principal })) };

            try {
                const res = await fetch('/Kanji/SalvarTraducoes', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (res.ok) {
                    const data = await res.json();
                    bootstrap.Modal.getInstance(document.getElementById('modalTraducao')).hide();
                    const b = document.getElementById('btn-kanji-' + kId);
                    if (b) {
                        b.classList.remove('btn-outline-secondary'); b.classList.add('btn-success'); b.title = "Traduzido";
                        b.style.transition = "transform 0.3s"; b.style.transform = "scale(1.3)"; setTimeout(() => b.style.transform = "scale(1)", 500);
                        const secaoPai = b.closest('.kanji-section');
                        if (secaoPai) atualizarBarraProgresso(secaoPai);
                    }
                    document.getElementById('txtMensagemSucesso').innerText = data.mensagem;
                    const ms = new bootstrap.Modal(document.getElementById('modalSucesso')); ms.show();
                    setTimeout(() => { ms.hide(); }, 1000);
                } else {
                    const erroTxt = await res.text();
                    const modalContent = document.querySelector('#modalTraducao .modal-content');
                    modalContent.classList.add('shake-effect'); setTimeout(() => modalContent.classList.remove('shake-effect'), 500);
                    if (msgEl) { msgEl.innerText = "⚠️ " + erroTxt; msgEl.style.display = 'block'; setTimeout(() => msgEl.style.display = 'none', 4000); }
                }
            } catch (e) { console.error(e); }
            finally { if (document.body.classList.contains('modal-open')) { btn.disabled = false; btn.innerHTML = originalText; } }
        }

        function modalExcluirTraducao(idTraducao) {
            document.getElementById('footerBtnDefault').style.display = 'none';
            document.getElementById('footerBtnConfirm').style.display = 'flex';
            const btnSim = document.getElementById('btnConfirmarExclusao');
            btnSim.onclick = () => executarExclusao(idTraducao);
        }

        function cancelarExclusao() {
            document.getElementById('footerBtnConfirm').style.display = 'none';
            document.getElementById('footerBtnDefault').style.display = 'flex';
        }

        async function executarExclusao(idTraducao) {
            const btnSim = document.getElementById('btnConfirmarExclusao');
            const originalHtml = btnSim.innerHTML;
            btnSim.disabled = true; btnSim.innerHTML = '<i class="fa fa-spinner fa-spin"></i> ...';
            try {
                const response = await fetch(`/Kanji/ExcluirTraducao?id=${idTraducao}`, { method: 'POST' });
                if (response.ok) {
                    const data = await response.json();
                    const kId = data.id || document.getElementById('modalKanjiId').value;
                    const btnPrincipal = document.getElementById('btn-kanji-' + kId);
                    if (btnPrincipal) {
                        if (data.temMais === false) { btnPrincipal.classList.remove('btn-success'); btnPrincipal.classList.add('btn-outline-secondary'); btnPrincipal.title = "Pendente"; }
                        else { btnPrincipal.classList.remove('btn-outline-secondary'); btnPrincipal.classList.add('btn-success'); btnPrincipal.title = "Traduzido"; }
                        const secaoPai = btnPrincipal.closest('.kanji-section');
                        if (secaoPai) atualizarBarraProgresso(secaoPai);
                    }
                    document.getElementById('footerBtnConfirm').style.display = 'none';
                    const msgEl = document.getElementById('msgErroModal');
                    if (msgEl) { msgEl.className = "text-success fw-bold small me-auto"; msgEl.innerText = "✅ Removido!"; msgEl.style.display = "block"; }
                    const modalContent = document.querySelector('#modalTraducao .modal-content');
                    modalContent.classList.add('success-effect');
                    setTimeout(() => { modalContent.classList.remove('success-effect'); abrirModal(kId); }, 1500);
                } else {
                    const erroTxt = await response.text();
                    alert("Erro: " + erroTxt);
                    btnSim.disabled = false; btnSim.innerHTML = originalHtml;
                }
            } catch (e) {
                console.error(e);
                btnSim.disabled = false; btnSim.innerHTML = originalHtml;
            }
        }

        function atualizarBarraProgresso(sectionElement) {
            if (!sectionElement) return;
            const total = sectionElement.querySelectorAll('.kanji-btn').length;
            const traduzidos = sectionElement.querySelectorAll('.kanji-btn.btn-success').length;
            const pct = total > 0 ? Math.floor((traduzidos / total) * 100) : 0;
            const txtPct = sectionElement.querySelector('.js-pct');
            const txtCont = sectionElement.querySelector('.js-count');
            const bar = sectionElement.querySelector('.js-bar');
            if (txtPct) txtPct.innerText = pct + "%";
            if (txtCont) txtCont.innerText = traduzidos + " / " + total;
            if (bar) {
                bar.style.width = pct + "%"; bar.setAttribute('aria-valuenow', pct);
                bar.className = "progress-bar progress-bar-striped progress-bar-animated js-bar";
                if (pct < 10) bar.classList.add("bg-danger"); else if (pct < 30) bar.classList.add("bg-warning"); else bar.classList.add("bg-success");
            }
        }

        // ==========================================
        // 8. LÓGICA DO EDITOR DE HISTÓRIAS (NOVO - SyntaxHighlight)
        // ==========================================

        function abrirEditorHistoria(idMeaning, texto, lingua, temHistoria) {
            // 1. Preenche os dados do cabeçalho
            document.getElementById('lblEditorTitulo').innerText = texto;
            document.getElementById('lblEditorLingua').innerText = lingua;
            document.getElementById('editorMeaningId').value = idMeaning;

            // 2. Esconde o footer principal
            const footer = document.getElementById('modalFooterPadrao');
            if(footer) footer.style.display = 'none';

            // 3. Prepara o editor
            const txtArea = document.getElementById('txtEditorHistoria');
            txtArea.value = "Carregando...";

            // Simulação - Depois faremos o fetch real
            if(temHistoria) {
                txtArea.value = "";
            } else {
                txtArea.value = "";
            }
            atualizarPreviewEditor();

            // 4. Slide para a esquerda
            document.getElementById('sliderWrapper').style.transform = "translateX(-50%)";
        }

        function voltarParaDetalhes() {
            document.getElementById('sliderWrapper').style.transform = "translateX(0)";
            setTimeout(() => {
                const footer = document.getElementById('modalFooterPadrao');
                if(footer) footer.style.display = 'flex';
            }, 300);
        }

        function inserirTagEditor(tag) {
            const txtArea = document.getElementById('txtEditorHistoria');
            const start = txtArea.selectionStart;
            const end = txtArea.selectionEnd;
            const text = txtArea.value;
            const selection = text.substring(start, end);
            const content = selection.length > 0 ? selection : "texto";
            const tagFull = `<${tag}>${content}</${tag}>`;
            txtArea.value = text.substring(0, start) + tagFull + text.substring(end);
            txtArea.focus();
            atualizarPreviewEditor();
        }

        function atualizarPreviewEditor() {
            const raw = document.getElementById('txtEditorHistoria').value;
            // Simulação visual simples
            let formatted = raw
                .replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/&lt;v&gt;(.*?)&lt;\/v&gt;/g, '<span style="color:#dc3545; font-weight:bold;">$1</span>')
                .replace(/&lt;n&gt;(.*?)&lt;\/n&gt;/g, '<span style="color:#0d6efd; font-weight:bold;">$1</span>')
                .replace(/&lt;adj&gt;(.*?)&lt;\/adj&gt;/g, '<span style="color:#198754; font-style:italic;">$1</span>')
                .replace(/&lt;mark&gt;(.*?)&lt;\/mark&gt;/g, '<span style="background-color:#ffc107;">$1</span>')
                .replace(/\n/g, '<br>');
            const divPreview = document.getElementById('divEditorPreview');
            if(divPreview) divPreview.innerHTML = formatted;
        }

        async function salvarHistoriaBackend() {
            const id = document.getElementById('editorMeaningId').value;
            const texto = document.getElementById('txtEditorHistoria').value;

            const btn = event.target; // Captura o botão clicado
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Salvando...';

            const payload = { MeaningId: parseInt(id), Texto: texto };
            console.log("Enviando:", payload);

            // Simulação
            setTimeout(() => {
                btn.innerHTML = '<i class="fa fa-check"></i> Salvo!';
                btn.classList.remove('btn-success'); btn.classList.add('btn-dark');
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    btn.classList.add('btn-success'); btn.classList.remove('btn-dark');
                    voltarParaDetalhes();
                }, 1000);
            }, 1000);
        }
    </script>
}