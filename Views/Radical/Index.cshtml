@model Denkiishi_v2.Models.RadicalGeralViewModel

<div class="modal fade" id="modalTraducao" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="modalConteudoDinamico"></div>
    </div>
</div>

<div class="modal fade" id="modalSucesso" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content text-center border-0 shadow-lg">
            <div class="modal-body p-4">
                <div class="mb-3"><i class="fa fa-check-circle text-success" style="font-size: 4rem;"></i></div>
                <h4 class="fw-bold text-success mb-3">Sucesso!</h4>
                <p class="lead fs-6 text-muted mb-4" id="txtMensagemSucesso">...</p>
                <button type="button" class="btn btn-success w-100 rounded-pill" data-bs-dismiss="modal">Legal! (Enter)</button>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">

    <div class="row align-items-center mb-4 border-bottom pb-3">
        <div class="col-md-4">
            <h2 class="text-primary m-0"><i class="fa fa-th"></i> Mapa de Radicais</h2>
        </div>

        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="fa fa-search text-muted"></i></span>
                <input type="text" id="inputBusca" class="form-control border-start-0" placeholder="Buscar Radical ou significado..." onkeyup="filtrarRadicais()">
            </div>
        </div>

        <div class="col-md-4 text-end mt-2 mt-md-0">
            <form asp-action="Index" method="get" class="d-inline-flex align-items-center">
                <label class="me-2 fw-bold small">Verificar em:</label>
                <select name="linguaId" asp-items="Model.LinguasDisponiveis" class="form-select w-auto" onchange="this.form.submit()"></select>
            </form>
        </div>
    </div>

    @foreach (var grupo in Model.RadicaisPorTracos)
    {
        string nomeGrupo = $"{grupo.Key} Traços";

        // Cálculos
        int total = grupo.Value.Count;
        int traduzidos = grupo.Value.Count(r => r.TemTraducao);
        int porcentagem = total > 0 ? (int)((double)traduzidos / total * 100) : 0;

        string corBarra = "bg-success";
        if (porcentagem < 30) corBarra = "bg-warning";
        if (porcentagem < 10) corBarra = "bg-danger";

        <div class="card mb-4 shadow-sm radical-section" id="section-t@grupo.Key">

            <div class="card-header bg-dark text-white pb-3">
                <div class="d-flex justify-content-between align-items-end mb-2">
                    <div class="d-flex align-items-center gap-2">
                        <h4 class="m-0 fw-bold">@nomeGrupo</h4>
                        <span class="badge bg-secondary rounded-pill small">@total radicais</span>
                    </div>

                    <div class="text-end">
                        <span id="txt-progresso-t@grupo.Key" class="fw-bold text-white fs-5">@porcentagem%</span>
                        <div class="small text-white-50" id="txt-contador-t@grupo.Key">@traduzidos / @total</div>
                    </div>
                </div>

                <div class="progress bg-secondary bg-opacity-25" style="height: 10px; border-radius: 10px;">
                    <div id="bar-t@grupo.Key"
                         class="progress-bar @corBarra progress-bar-striped progress-bar-animated"
                         role="progressbar"
                         style="width: @porcentagem%; transition: width 1s ease;"
                         aria-valuenow="@porcentagem"
                         aria-valuemin="0"
                         aria-valuemax="100">
                    </div>
                </div>
            </div>

            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var radical in grupo.Value)
                    {
                        string classeBotao = radical.TemTraducao ? "btn-success" : "btn-outline-secondary";

                        <button id="btn-radical-@radical.Id"
                                onclick="abrirModal(@radical.Id)"
                                class="btn @classeBotao d-flex justify-content-center align-items-center fw-bold fs-5 shadow-sm radical-btn"
                                style="width: 50px; height: 50px;"
                                title="@(radical.TemTraducao ? "Traduzido" : "Pendente")"
                                data-search="@radical.SearchText">
                            @radical.Literal
                        </button>
                    }
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // 1. VARIÁVEIS GLOBAIS
        let modalPalavras = [];

        // 2. BUSCA (Renomeada para Radicais)
        function filtrarRadicais() {
            const termo = document.getElementById('inputBusca').value.toLowerCase().trim();
            // Seletores atualizados
            const botoes = document.querySelectorAll('.radical-btn');
            const secoes = document.querySelectorAll('.radical-section');

            botoes.forEach(btn => {
                const keywords = btn.getAttribute('data-search');
                if (termo === "" || keywords.includes(termo)) {
                    btn.classList.remove('d-none');
                    btn.classList.add('d-flex');
                } else {
                    btn.classList.add('d-none');
                    btn.classList.remove('d-flex');
                }
            });

            secoes.forEach(sec => {
                const visiveis = sec.querySelectorAll('.radical-btn:not(.d-none)').length;
                sec.style.display = visiveis > 0 ? 'block' : 'none';
            });
        }

        // 3. ABRIR MODAL
        async function abrirModal(id) {
            modalPalavras = [];
            const modalEl = document.getElementById('modalTraducao');

            let modal = bootstrap.Modal.getInstance(modalEl);
            if (!modal) modal = new bootstrap.Modal(modalEl);
            if (!modalEl.classList.contains('show')) modal.show();

            document.getElementById('modalConteudoDinamico').innerHTML =
                `<div class="modal-body text-center p-5"><div class="spinner-border text-primary"></div></div>`;

            try {
                const r = await fetch(`/Radical/DetalhesModal/${id}?v=${new Date().getTime()}`);
                if(r.ok) {
                    document.getElementById('modalConteudoDinamico').innerHTML = await r.text();
                    // ============================================================
                    // 2. CÓDIGO NOVO: INICIALIZAR POPOVERS (VERSÃO BLINDADA)
                    // ============================================================

                    // 1. Encontra os botões que devem ter popover
                    const listaBotoes = document.querySelectorAll('#modalConteudoDinamico [data-bs-toggle="popover"]');
                    console.log("Botões encontrados para Popover: " + listaBotoes.length);

                    // 2. Inicializa cada um com configurações permissivas
                    var popoverList = [].slice.call(listaBotoes).map(function (elementoBtn) {
                        return new bootstrap.Popover(elementoBtn, {
                            container: 'body',  // Garante que fica por cima do Modal
                            html: true,         // Permite HTML
                            sanitize: false,    // <--- O SEGREDO! Permite estilos e classes no HTML
                            trigger: 'hover',   // Abre instantaneamente ao passar o mouse
                            placement: 'top'    // Tenta mostrar em cima
                        });
                    });
                    // ============================================================
                } else {
                    document.getElementById('modalConteudoDinamico').innerHTML = '<div class="p-3 text-danger">Erro ao carregar.</div>';
                }
            } catch(e) { console.error(e); }
        }

        // 4. LÓGICA DO MODAL
        function modalAddPalavra() {
            const input = document.getElementById('modalInputPalavra');
            if(!input) return;
            const t = input.value.trim();

            if(!t) return;

            if(modalPalavras.some(p => p.texto.toLowerCase() === t.toLowerCase())) {
                const msgEl = document.getElementById('msgErroModal');
                if(msgEl) {
                    msgEl.innerText = "⚠️ Palavra já está na lista.";
                    msgEl.style.display = 'block';
                    setTimeout(() => msgEl.style.display = 'none', 3000);
                }
                return;
            }

            modalPalavras.push({texto: t, principal: modalPalavras.length === 0});
            input.value = '';
            input.focus();
            modalRender();
        }

        function modalRender() {
            const c = document.getElementById('modalContainerChips');
            c.innerHTML = '';

            if(modalPalavras.length === 0) {
                c.innerHTML = '<span class="text-muted small w-100 text-center align-self-center fst-italic">Lista vazia...</span>';
                return;
            }

            modalPalavras.forEach((item, i) => {
                const d = document.createElement('div');
                d.className = `badge ${item.principal ? 'bg-primary' : 'bg-secondary'} fs-6 rounded px-3 py-2 d-flex align-items-center gap-2 pointer`;
                d.style.cursor = 'pointer';
                d.onclick = () => { modalPalavras.forEach((p, idx) => p.principal = (idx === i)); modalRender(); };

                d.innerHTML = `
                    <span>${item.texto}${item.principal ? ' <i class="fa fa-star text-warning"></i>' : ''}</span>
                    <span onclick="event.stopPropagation(); modalPalavras.splice(${i},1); modalRender();"
                          class="ms-2 fw-bold text-white-50 hover-white" style="cursor:pointer;">&times;</span>
                `;
                c.appendChild(d);
            });
        }

        // 5. ATUALIZAR BARRA (Renomeada logica interna)
        function atualizarBarraProgresso(sectionElement) {
            if(!sectionElement) return;

            // ID agora é 'section-t3' (t de traços), removemos 'section-t'
            const grupoId = sectionElement.id.replace('section-t', '');

            const total = sectionElement.querySelectorAll('.radical-btn').length;
            const traduzidos = sectionElement.querySelectorAll('.radical-btn.btn-success').length;
            const pct = total > 0 ? Math.floor((traduzidos / total) * 100) : 0;

            const txtPct = document.getElementById('txt-progresso-t' + grupoId);
            const txtCont = document.getElementById('txt-contador-t' + grupoId);
            const bar = document.getElementById('bar-t' + grupoId);

            if(txtPct) txtPct.innerText = pct + "%";
            if(txtCont) txtCont.innerText = traduzidos + " / " + total;

            if(bar) {
                bar.style.width = pct + "%";
                bar.setAttribute('aria-valuenow', pct);
                bar.className = "progress-bar progress-bar-striped progress-bar-animated";
                if(pct < 10) bar.classList.add("bg-danger");
                else if(pct < 30) bar.classList.add("bg-warning");
                else bar.classList.add("bg-success");
            }
        }

        // 6. SALVAR
        async function modalSalvar() {
            const msgEl = document.getElementById('msgErroModal');
            if(msgEl) msgEl.style.display = 'none';

            if (modalPalavras.length === 0) {
                if(msgEl) { msgEl.innerText = "⚠️ Adicione ao menos uma palavra."; msgEl.style.display = 'block'; }
                return;
            }

            const btn = document.getElementById('btnModalSalvar');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Salvando...';

            // IMPORTANTE: O modal _ModalContent deve ter o ID modalRadicalId agora
            // Se ainda não atualizou o partial, use document.getElementById('modalKanjiId') como fallback
            const rIdInput = document.getElementById('modalRadicalId') || document.getElementById('modalKanjiId');
            const rId = rIdInput.value;
            const lId = document.getElementById('modalComboLingua').value;

            // ATENÇÃO: Mantemos a chave "KanjiId" no JSON pois o Controller C# (SalvarTraducaoRequest)
            // ainda espera esse nome genérico na classe DTO.
            const payload = {
                KanjiId: parseInt(rId),
                LinguaId: parseInt(lId),
                Palavras: modalPalavras.map(p => ({ Texto: p.texto, EhPrincipal: p.principal }))
            };

            try {
                const res = await fetch('/Radical/SalvarTraducoes', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });

                if(res.ok) {
                    const data = await res.json();
                    bootstrap.Modal.getInstance(document.getElementById('modalTraducao')).hide();

                    const b = document.getElementById('btn-radical-' + rId);
                    if(b) {
                        b.classList.remove('btn-outline-secondary');
                        b.classList.add('btn-success');
                        b.title = "Traduzido";
                        b.style.transition = "transform 0.3s";
                        b.style.transform = "scale(1.3)";
                        setTimeout(() => b.style.transform = "scale(1)", 500);

                        // Atualiza barra
                        const secaoPai = b.closest('.radical-section');
                        if(secaoPai) atualizarBarraProgresso(secaoPai);
                    }

                    document.getElementById('txtMensagemSucesso').innerText = data.mensagem;
                    const ms = new bootstrap.Modal(document.getElementById('modalSucesso'));
                    ms.show();
                        setTimeout(() => {
            ms.hide();
        }, 1500);
                    document.getElementById('modalSucesso').addEventListener('shown.bs.modal', e => e.target.querySelector('button').focus(), {once:true});

                } else {
                    const erroTxt = await res.text();
                    const modalContent = document.querySelector('#modalTraducao .modal-content');
                    modalContent.classList.add('shake-effect');
                    setTimeout(() => modalContent.classList.remove('shake-effect'), 500);
                    if(msgEl) { msgEl.innerText = "⚠️ " + erroTxt; msgEl.style.display = 'block'; setTimeout(() => msgEl.style.display = 'none', 4000); }
                }
            } catch(e) { console.error(e); }
            finally { if(document.body.classList.contains('modal-open')) { btn.disabled = false; btn.innerHTML = originalText; } }
        }

        // 7. EXCLUSÃO
        function modalExcluirTraducao(idTraducao) {
            document.getElementById('footerBtnDefault').style.display = 'none';
            document.getElementById('footerBtnConfirm').style.display = 'flex';
            const btnSim = document.getElementById('btnConfirmarExclusao');
            btnSim.onclick = () => executarExclusao(idTraducao);
        }

        function cancelarExclusao() {
            document.getElementById('footerBtnConfirm').style.display = 'none';
            document.getElementById('footerBtnDefault').style.display = 'flex';
        }

        async function executarExclusao(idTraducao) {
             const btnSim = document.getElementById('btnConfirmarExclusao');
             const originalHtml = btnSim.innerHTML;
             btnSim.disabled = true;
             btnSim.innerHTML = '<i class="fa fa-spinner fa-spin"></i> ...';

             try {
                 const response = await fetch(`/Radical/ExcluirTraducao?id=${idTraducao}`, { method: 'POST' });

                 if (response.ok) {
                     // 1. Lê os dados que mandamos do C# (temMais, id)
                     const data = await response.json();

                     // 2. ATUALIZA A TELA PRINCIPAL (Index)
                     const radicalId = document.getElementById('modalRadicalId').value;
                     const btnPrincipal = document.getElementById('btn-radical-' + radicalId);

                     if (btnPrincipal) {
                         // Se não tem mais traduções, volta a ser cinza
                         if (!data.temMais) {
                             btnPrincipal.classList.remove('btn-success');
                             btnPrincipal.classList.add('btn-outline-secondary');
                             btnPrincipal.title = "Pendente";
                         }
                         // Se tem mais, garante que está verde (caso estivesse cinza por erro)
                         else {
                             btnPrincipal.classList.remove('btn-outline-secondary');
                             btnPrincipal.classList.add('btn-success');
                             btnPrincipal.title = "Traduzido";
                         }

                         // ATUALIZA A BARRA DE PROGRESSO (para menos ou para mais)
                         const secaoPai = btnPrincipal.closest('.radical-section');
                         if (secaoPai) atualizarBarraProgresso(secaoPai);
                     }

                     // 3. Feedback Visual no Modal (Igual já estava)
                     document.getElementById('footerBtnConfirm').style.display = 'none';
                     const msgEl = document.getElementById('msgErroModal');
                     if(msgEl) { msgEl.className = "text-success fw-bold small me-auto"; msgEl.innerText = "✅ Removido!"; msgEl.style.display = "block"; }

                     const modalContent = document.querySelector('#modalTraducao .modal-content');
                     modalContent.classList.add('success-effect');

                     setTimeout(() => {
                         modalContent.classList.remove('success-effect');
                         abrirModal(radicalId);
                     }, 1500);

                 } else {
                     const erroTxt = await response.text();
                     // ... (resto do tratamento de erro igual)
                     alert("Erro: " + erroTxt);
                     btnSim.disabled = false; btnSim.innerHTML = originalHtml;
                 }
             } catch (e) {
                 console.error(e);
                 alert("Erro de conexão.");
                 btnSim.disabled = false; btnSim.innerHTML = originalHtml;
             }
         }
    </script>
}

<style>
    /* Estilos das Animações (Mantidos) */
    @@keyframes shake {
        0%, 100% {
            transform: translateX(0);
        }

        10%, 30%, 50%, 70%, 90% {
            transform: translateX(-5px);
        }

        20%, 40%, 60%, 80% {
            transform: translateX(5px);
        }
    }

    .shake-effect {
        animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        border: 3px solid #dc3545 !important;
        box-shadow: 0 0 15px rgba(220, 53, 69, 0.6) !important;
    }

    @@keyframes jump-success {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0);
        }

        40% {
            transform: translateY(-20px);
        }

        60% {
            transform: translateY(-10px);
        }
    }

    .success-effect {
        border: 4px solid #198754 !important;
        box-shadow: 0 0 40px rgba(25, 135, 84, 0.9) !important;
        animation: jump-success 1s ease;
    }

    .hover-white:hover {
        color: white !important;
    }

    /* === MANTENDO O ESTILO DOS BOTÕES === */
    /* Como renomeamos para .radical-btn, copiamos os estilos do kanji-btn aqui para garantir que fique bonito */
    .radical-btn {
        transition: all 0.2s;
        border-width: 2px;
    }

        .radical-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    /* Força o Popover a ficar ACIMA do Modal (que geralmente é 1055) */
    .popover {
        z-index: 1100 !important;
    }
</style>