@model Denkiishi_v2.Models.VocabularyGeralViewModel

<div class="modal fade" id="modalTraducao" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="modalConteudoDinamico"></div>
    </div>
</div>

<div class="container mt-4">
    <div class="row align-items-center mb-4 border-bottom pb-3">
        <div class="col-md-4">
            <h2 class="text-vocab m-0 fw-bold"><i class="fa fa-book-open"></i> Vocabulário</h2>
        </div>

        <div class="col-md-3">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="fa fa-search text-muted"></i></span>
                <input type="text" id="inputBusca" class="form-control border-start-0" placeholder="Buscar palavra, kana ou significado..." onkeyup="filtrarVocab()">
            </div>
        </div>

        <div class="col-md-5 text-end mt-2 mt-md-0">
            <form asp-action="Index" method="get" class="d-inline-flex align-items-center gap-3">

                <div class="d-flex align-items-center">
                    <label class="me-2 fw-bold small text-muted"><i class="fa fa-filter"></i> Sistema:</label>
                    <select name="categoriaId" asp-items="Model.CategoriasDisponiveis" class="form-select w-auto fw-bold text-vocab border-vocab" onchange="this.form.submit()"></select>
                </div>

                <div class="d-flex align-items-center">
                    <label class="me-2 fw-bold small text-muted">Idioma:</label>
                    <select name="linguaId" asp-items="Model.LinguasDisponiveis" class="form-select w-auto" onchange="this.form.submit()"></select>
                </div>

            </form>
        </div>
    </div>

    @if (!Model.VocabPorNivel.Any())
    {
        <div class="alert alert-light text-center border mt-5 py-5 text-muted">
            <i class="fa fa-ghost fa-3x mb-3 opacity-25"></i>
            <h5>Nenhum vocabulário cadastrado para esta categoria.</h5>
        </div>
    }

    @foreach (var nivel in Model.VocabPorNivel)
    {
        // Se a Categoria selecionada for JLPT, podemos embelezar o nome
        string nomeNivel = "Nível " + nivel.Key;
        var catSelecionada = Model.CategoriasDisponiveis.FirstOrDefault(c => c.Selected)?.Text;
        if (catSelecionada == "JLPT") nomeNivel = "JLPT N" + nivel.Key;

        int total = nivel.Value.Count;
        int traduzidos = nivel.Value.Count(v => v.TemTraducao);
        int porcentagem = total > 0 ? (int)((double)traduzidos / total * 100) : 0;

        <div class="card mb-4 shadow-sm vocab-section" id="section-v-@nivel.Key">
            <div class="card-header bg-vocab text-white pb-3">
                <div class="d-flex justify-content-between align-items-end mb-2">
                    <div class="d-flex align-items-center gap-2">
                        <h4 class="m-0 fw-bold">@nomeNivel</h4>
                        <span class="badge bg-white text-vocab rounded-pill small fw-bold">@total palavras</span>
                    </div>
                    <div class="text-end">
                        <span class="fw-bold text-white fs-5 js-pct">@porcentagem%</span>
                        <div class="small text-white-50 js-count">@traduzidos / @total</div>
                    </div>
                </div>
                <div class="progress bg-white bg-opacity-25" style="height: 10px; border-radius: 10px;">
                    <div class="progress-bar bg-white progress-bar-striped js-bar" role="progressbar" style="width: @porcentagem%;" aria-valuenow="@porcentagem" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>

            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var vocab in nivel.Value)
                    {
                        string classeBotao = vocab.TemTraducao ? "btn-vocab-success" : "btn-outline-secondary";

                        <button onclick="abrirModal(@vocab.Id)"
                                class="btn @classeBotao d-flex flex-column justify-content-center align-items-center shadow-sm vocab-btn"
                                style="min-width: 80px; height: auto; padding: 6px 12px; transition: transform 0.2s, box-shadow 0.2s;"
                                title="@(vocab.TemTraducao ? "Traduzido" : "Pendente")"
                                data-search="@vocab.SearchText">
                            <span class="fw-bold fs-4 mb-0" style="line-height: 1.2;">@vocab.Palavra</span>
                            <small class="small text-opacity-75" style="font-size: 0.75rem;">@vocab.LeituraPrincipal</small>
                        </button>
                    }
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // 1. FILTRAGEM NA TELA
        function filtrarVocab() {
            const termo = document.getElementById('inputBusca').value.toLowerCase().trim();
            const botoes = document.querySelectorAll('.vocab-btn');
            const secoes = document.querySelectorAll('.vocab-section');

            botoes.forEach(btn => {
                const keywords = btn.getAttribute('data-search');
                if (termo === "" || keywords.includes(termo)) {
                    btn.classList.remove('d-none'); btn.classList.add('d-flex');
                } else {
                    btn.classList.add('d-none'); btn.classList.remove('d-flex');
                }
            });

            secoes.forEach(sec => {
                const visiveis = sec.querySelectorAll('.vocab-btn:not(.d-none)').length;
                sec.style.display = visiveis > 0 ? 'block' : 'none';
            });
        }

        // 2. ABRIR O MODAL (MOCK PARA O PRÓXIMO PASSO)
        async function abrirModal(id) {
            const modalEl = document.getElementById('modalTraducao');
            let modal = bootstrap.Modal.getInstance(modalEl);
            if (!modal) modal = new bootstrap.Modal(modalEl);
            modal.show();

            document.getElementById('modalConteudoDinamico').innerHTML =
                `<div class="modal-body text-center p-5"><div class="spinner-border text-vocab"></div></div>`;

            try {
                // Rota que criaremos a seguir
                const r = await fetch(`/Vocabulary/DetalhesModal/${id}`);
                if(r.ok) {
                    document.getElementById('modalConteudoDinamico').innerHTML = await r.text();
                } else {
                    document.getElementById('modalConteudoDinamico').innerHTML = '<div class="p-3 text-danger">Erro ao carregar detalhes.</div>';
                }
            } catch(e) { console.error(e); }
        }
            async function salvarNovaTraducao(e) {
            e.preventDefault(); // Evita que a página recarregue

            const form = e.target;
            const btn = form.querySelector('button[type="submit"]');
            const textoOriginal = btn.innerHTML;

            // Coloca um "loading" no botão
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            btn.disabled = true;

            const formData = new FormData(form);

            try {
                const response = await fetch('/Vocabulary/AddMeaning', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    // Se deu certo, recarrega o Modal chamando a função que já existe na tela principal
                    const vocabId = document.getElementById('vocabId').value;
                    abrirModal(vocabId);
                } else {
                    alert('Erro ao salvar tradução.');
                    btn.innerHTML = textoOriginal;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error(error);
                alert('Falha na comunicação com o servidor.');
                btn.innerHTML = textoOriginal;
                btn.disabled = false;
            }
        }
        // ==========================================
        // LÓGICA DO SLIDER DO MNEMÔNICO & SYNTAX
        // ==========================================

        function abrirPainelMnemonic(meaningId, texto) {
            document.getElementById('sliderMnemonic').style.transform = 'translateX(-33.333%)';
            document.getElementById('labelTraducao').innerText = `"${texto}"`;
            document.getElementById('currentMeaningId').value = meaningId;

            // Reseta a tela
            document.getElementById('txtMnemonic').value = 'Carregando...';
            document.getElementById('divMnemonicPreview').innerHTML = '';
            document.getElementById('btnExcluirMnemonic').classList.add('d-none');
            document.getElementById('currentMnemonicId').value = '0';

            fetch(`/Vocabulary/GetMeaningMnemonic?meaningId=${meaningId}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('txtMnemonic').value = data.text;

                    if (data.id > 0) {
                        document.getElementById('currentMnemonicId').value = data.id;
                        document.getElementById('btnExcluirMnemonic').classList.remove('d-none');
                    }
                    // Atualiza o preview na hora que os dados chegam
                    atualizarPreviewMnemonic();
                });
        }

        function fecharPainelMnemonic() {
            document.getElementById('sliderMnemonic').style.transform = 'translateX(0%)';
        }


        function abrirPainelReadings() {
            // Vai para -66.666% (Slide 3)
            document.getElementById('sliderMnemonic').style.transform = "translateX(-66.666%)";
        }

        function fecharParaPrincipal() {
            // Volta para 0% (Slide 1)
            document.getElementById('sliderMnemonic').style.transform = 'translateX(0%)';
        }
        // --- FUNÇÕES DO SYNTAX HIGHLIGHT ---
        function inserirTagMnemonic(tag) {
            const txtArea = document.getElementById('txtMnemonic');
            const start = txtArea.selectionStart;
            const end = txtArea.selectionEnd;
            const text = txtArea.value;
            const selection = text.substring(start, end);

            const content = selection.length > 0 ? selection : "texto";
            const tagFull = `<${tag}>${content}</${tag}>`;

            txtArea.value = text.substring(0, start) + tagFull + text.substring(end);

            // Reposiciona o cursor
            if (selection.length > 0) {
                const newPos = start + tagFull.length;
                txtArea.setSelectionRange(newPos, newPos);
            } else {
                txtArea.setSelectionRange(start + tag.length + 2, start + tag.length + 2 + content.length);
            }

            txtArea.focus();
            atualizarPreviewMnemonic();
        }

        function atualizarPreviewMnemonic() {
            let raw = document.getElementById('txtMnemonic').value;
            if(!raw || raw === 'Carregando...') {
                document.getElementById('divMnemonicPreview').innerHTML = '';
                return;
            }

            // 1. Sanitização
            raw = raw.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            let formatted = raw.replace(/\n/g, '<br>');

            // 2. Recuperar as regras
            let regras = [];
            const inputRegras = document.getElementById('dadosSyntaxHighlight');
            if (inputRegras && inputRegras.value) {
                try { regras = JSON.parse(inputRegras.value); } catch (e) {}
            }

            // 3. Aplica o CSS
            if (regras && Array.isArray(regras)) {
                regras.forEach(rule => {
                    let style = "";
                    if (rule.textColor) style += `color:${rule.textColor};`;
                    if (rule.bgColor) style += `background-color:${rule.bgColor}; padding: 0 2px; border-radius: 3px;`;
                    if (rule.bold) style += "font-weight:bold;";
                    if (rule.italic) style += "font-style:italic;";
                    if (rule.underline) style += "text-decoration:underline;";

                    const regex = new RegExp(`&lt;${rule.code}&gt;(.*?)&lt;/${rule.code}&gt;`, 'g');
                    formatted = formatted.replace(regex, `<span style="${style}">$1</span>`);
                });
            }

            document.getElementById('divMnemonicPreview').innerHTML = formatted;
        }

        // --- SALVAR E EXCLUIR ---
        async function salvarMnemonic() {
            const btn = document.getElementById('btnSalvarMnemonic');
            const originalTxt = btn.innerHTML;

            const meaningId = document.getElementById('currentMeaningId').value;
            const mnemonicId = document.getElementById('currentMnemonicId').value;
            const text = document.getElementById('txtMnemonic').value;

            if(!text.trim()) { alert('Digite algo para salvar!'); return; }

            btn.disabled = true; btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Salvando...';

            const formData = new FormData();
            formData.append('meaningId', meaningId);
            formData.append('text', text);
            formData.append('mnemonicId', mnemonicId);

            try {
                const response = await fetch('/Vocabulary/SaveMeaningMnemonic', { method: 'POST', body: formData });
                if(response.ok) {
                    const vocabId = document.getElementById('vocabId').value;
                    abrirModal(vocabId); // Recarrega para mostrar a estrela amarela!
                }
            } catch (e) { alert('Erro ao salvar!'); }
            finally { btn.disabled = false; btn.innerHTML = originalTxt; }
        }

        async function excluirMnemonic() {
            if(!confirm('Certeza que deseja excluir este mnemônico?')) return;

            const mnemonicId = document.getElementById('currentMnemonicId').value;
            const formData = new FormData();
            formData.append('mnemonicId', mnemonicId);

            try {
                const response = await fetch('/Vocabulary/DeleteMeaningMnemonic', { method: 'POST', body: formData });
                if(response.ok) {
                    const vocabId = document.getElementById('vocabId').value;
                    abrirModal(vocabId);
                }
            } catch (e) { alert('Erro ao excluir!'); }
        }

        

        function fecharPainelMnemonic() {
            // Desliza para a Direita (Volta ao normal)
            document.getElementById('sliderMnemonic').style.transform = 'translateX(0%)';
        }

        async function salvarMnemonic() {
            const meaningId = document.getElementById('currentMeaningId').value;
            const mnemonicId = document.getElementById('currentMnemonicId').value;
            const text = document.getElementById('txtMnemonic').value;

            if(!text.trim()) { alert('Digite algo para salvar!'); return; }

            const formData = new FormData();
            formData.append('meaningId', meaningId);
            formData.append('text', text);
            formData.append('mnemonicId', mnemonicId);

            try {
                const response = await fetch('/Vocabulary/SaveMeaningMnemonic', { method: 'POST', body: formData });
                if(response.ok) {
                    // Recarrega o modal para exibir o ícone e a cor do Primary
                    const vocabId = document.getElementById('vocabId').value;
                    abrirModal(vocabId);
                }
            } catch (e) { alert('Erro ao salvar!'); }
        }

        async function excluirMnemonic() {
            if(!confirm('Certeza que deseja excluir este mnemônico?')) return;

            const mnemonicId = document.getElementById('currentMnemonicId').value;
            const formData = new FormData();
            formData.append('mnemonicId', mnemonicId);

            try {
                const response = await fetch('/Vocabulary/DeleteMeaningMnemonic', { method: 'POST', body: formData });
                if(response.ok) {
                    const vocabId = document.getElementById('vocabId').value;
                    abrirModal(vocabId);
                }
            } catch (e) { alert('Erro ao excluir!'); }
        }
        // (Lembre-se de atualizar o fecharPainelMnemonic para usar translateX(0%) também)

        // ==========================================
        // LÓGICA DO EDITOR DE LEITURAS (READINGS)
        // ==========================================
        async function selecionarReadingVocab(id, reading, temHistoria, isPrimary) {
            document.getElementById('msgSelecioneReadingVocab').style.display = 'none';
            document.getElementById('areaEdicaoReadingVocab').style.display = 'flex';
            document.getElementById('lblReadingSelecionadoVocab').innerText = reading;
            document.getElementById('hdnReadingIdVocab').value = id;
            document.getElementById('btnExcluirReadingVocab').style.display = temHistoria ? 'block' : 'none';

            const txt = document.getElementById('txtEditorReadingVocab');
            txt.value = "Carregando...";
            document.getElementById('divPreviewReadingVocab').innerHTML = '';

            if (temHistoria) {
                try {
                    const res = await fetch(`/Vocabulary/GetReadingMnemonic?readingId=${id}`);
                    if (res.ok) {
                        const data = await res.json();
                        txt.value = data.texto;
                        document.getElementById('divPreviewReadingVocab').innerHTML = data.formattedText || '';
                    } else { txt.value = "Erro ao carregar."; }
                } catch { txt.value = "Erro de conexão."; }
            } else {
                txt.value = "";
            }
        }

        function inserirTagReadingVocab(tag) {
            const txtArea = document.getElementById('txtEditorReadingVocab');
            const start = txtArea.selectionStart;
            const end = txtArea.selectionEnd;
            const text = txtArea.value;
            const selection = text.substring(start, end);
            const content = selection.length > 0 ? selection : "texto";
            const tagFull = `<${tag}>${content}</${tag}>`;

            txtArea.value = text.substring(0, start) + tagFull + text.substring(end);
            txtArea.setSelectionRange(start + tagFull.length, start + tagFull.length);
            txtArea.focus();
            atualizarPreviewReadingVocab();
        }

        function atualizarPreviewReadingVocab() {
            let raw = document.getElementById('txtEditorReadingVocab').value;
            if(!raw || raw === 'Carregando...') { document.getElementById('divPreviewReadingVocab').innerHTML = ''; return; }

            raw = raw.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            let formatted = raw.replace(/\n/g, '<br>');

            let regras = [];
            const inputRegras = document.getElementById('dadosSyntaxHighlight');
            if (inputRegras && inputRegras.value) { try { regras = JSON.parse(inputRegras.value); } catch(e){} }

            if (regras && Array.isArray(regras)) {
                regras.forEach(rule => {
                    let style = "";
                    if (rule.textColor) style += `color:${rule.textColor};`;
                    if (rule.bgColor) style += `background-color:${rule.bgColor}; padding: 0 2px; border-radius: 3px;`;
                    if (rule.bold) style += "font-weight:bold;";
                    const regex = new RegExp(`&lt;${rule.code}&gt;(.*?)&lt;/${rule.code}&gt;`, 'g');
                    formatted = formatted.replace(regex, `<span style="${style}">$1</span>`);
                });
            }
            document.getElementById('divPreviewReadingVocab').innerHTML = formatted;
        }

        async function salvarReadingBackendVocab() {
            const id = document.getElementById('hdnReadingIdVocab').value;
            const texto = document.getElementById('txtEditorReadingVocab').value;
            const btn = document.getElementById('btnSalvarReadingVocab');
            const originalHtml = btn.innerHTML;

            btn.disabled = true; btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Salvando...';

            const formData = new FormData();
            formData.append('readingId', id);
            formData.append('texto', texto);

            try {
                const res = await fetch('/Vocabulary/SaveReadingMnemonic', { method: 'POST', body: formData });
                if (res.ok) {
                    const vocabId = document.getElementById('vocabId').value;
                    abrirModal(vocabId); // Recarrega o modal principal para atualizar as estrelas
                } else { alert("Erro ao salvar."); btn.disabled = false; btn.innerHTML = originalHtml; }
            } catch (e) { console.error(e); btn.disabled = false; btn.innerHTML = originalHtml; }
        }

        async function excluirHistoriaReadingVocab() {
            if(!confirm("Tem certeza que deseja remover esta história?")) return;
            const id = document.getElementById('hdnReadingIdVocab').value;
            const formData = new FormData();
            formData.append('readingId', id);

            try {
                const res = await fetch(`/Vocabulary/ExcluirHistoriaReading`, { method: 'POST', body: formData });
                if(res.ok) {
                    const vocabId = document.getElementById('vocabId').value;
                    abrirModal(vocabId);
                } else { alert("Erro ao excluir."); }
            } catch(e) { console.error(e); }
        }
    </script>
}

<style>
    :root {
        /* A cor extraída da sua imagem para a tag <v> */
        --color-vocab-main: #20c997;
        --color-vocab-dark: #1aa179;
    }

    .text-vocab {
        color: var(--color-vocab-main) !important;
    }

    .bg-vocab {
        background-color: var(--color-vocab-main) !important;
        border-color: var(--color-vocab-main) !important;
    }

    .border-vocab {
        border-color: var(--color-vocab-main) !important;
    }

    /* Botão Traduzido (Borda verde menta, texto verde menta. Ao passar o mouse, inverte) */
    .btn-vocab-success {
        background-color: #ffffff;
        border: 2px solid var(--color-vocab-main);
        color: var(--color-vocab-dark);
    }

        .btn-vocab-success small {
            color: #6c757d; /* Cinza suave na leitura */
        }

        /* Efeito de Hover */
        .btn-vocab-success:hover {
            background-color: var(--color-vocab-main);
            color: #ffffff !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(32, 201, 151, 0.3) !important;
        }

            .btn-vocab-success:hover small {
                color: #e9ecef !important; /* Branco suave na leitura ao passar o mouse */
            }

    /* Hover dos botões cinzas (pendentes) */
    .btn-outline-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>