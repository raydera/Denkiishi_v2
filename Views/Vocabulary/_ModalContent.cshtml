@model Denkiishi_v2.Models.VocabularyDetalhesViewModel

<div class="modal-header bg-vocab text-white" style="background-color: #6f42c1;">
    <div class="d-flex align-items-center gap-3">
        <span class="badge bg-white text-dark rounded-pill">Nível @Model.Nivel</span>
        <h5 class="modal-title m-0 fw-bold">Detalhes do Vocabulário</h5>
    </div>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body bg-light">
    <div style="overflow-x: hidden;">
        <div id="sliderMnemonic" class="d-flex" style="width: 300%; transition: transform 0.3s ease-in-out;">

            <div id="panePrincipal" class="row g-4 m-0" style="width: 33.333%; padding-right: 15px;">

                <div class="col-md-5 p-0">
                    <div class="card shadow-sm text-center mb-3 border-vocab badge-clickable"
                         style="border-color: #20c997; cursor: pointer; transition: transform 0.2s;"
                         onclick="abrirPainelReadings()" title="Gerenciar Leituras">
                        <div class="card-body py-4">
                            <h1 class="display-3 fw-bold text-dark mb-0">@Model.Palavra</h1>
                            <div class="mt-2 d-flex flex-wrap justify-content-center gap-2">
                                @foreach (var r in Model.ListaReadings)
                                {
                                    <span class="fs-4 text-muted position-relative">
                                        @r.Reading
                                        @if (r.IsPrimary)
                                        {
                                            <i class="fa fa-star text-warning small ms-1"></i>
                                        }
                                        @if (r.TemHistoria)
                                        {
                                            <i class="fa fa-book-open text-info small ms-1"></i>
                                        }
                                    </span>
                                }
                            </div>
                            <div class="mt-3">@foreach (var tag in Model.ClassesGramaticais) {
                            <span class="badge bg-secondary me-1">@tag</span>
                                                        }
</div>
                        </div>
                    </div>
                    <div class="card shadow-sm">
                        <div class="card-header bg-white fw-bold text-muted small text-uppercase"><i class="fa fa-cubes"></i> Composição</div>
                        <div class="card-body p-2">
                            <div class="list-group list-group-flush">
                                @foreach (var k in Model.KanjisComponentes)
                                {
                                    string borderClass = k.Nivel <= 5 ? "border-primary" : "border-danger";
                                    <a asp-controller="Kanji" asp-action="Detalhes" asp-route-id="@k.Id" target="_blank" class="list-group-item list-group-item-action d-flex align-items-center justify-content-between p-2">
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-light text-dark border @borderClass me-3 fs-5" style="width:40px;">@k.Caractere</span>
                                            <span>@k.Significado</span>
                                        </div>
                                        <i class="fa fa-chevron-right text-muted small"></i>
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-7 d-flex flex-column gap-3 pe-0">

                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white py-2"><strong><i class="fa fa-list"></i> Significados</strong> <small class="text-muted ms-2">(Clique para Mnemônico)</small></div>
                        <div class="card-body bg-white">
                            @foreach (var grupo in Model.TraducoesAgrupadas)
                            {
                                <div class="mb-2">
                                    <strong class="text-vocab small">@grupo.Lingua</strong>
                                    <div class="d-flex flex-wrap gap-2 mt-1">
                                        @foreach (var sig in grupo.Significados)
                                        {
                                            // Cor Verde Menta se for Primary, Cinza se não for
                                            string btnClass = sig.IsPrimary ? "bg-vocab text-white border-vocab shadow-sm" : "bg-light text-dark border";
                                            string jsText = sig.Texto.Replace("'", "\\'"); // Previne quebras no JS

                                            <button onclick="abrirPainelMnemonic(@sig.Id, '@jsText')" class="btn btn-sm @btnClass fs-6 position-relative" style="transition: all 0.2s;">
                                                @sig.Texto
                                                @if (sig.IsPrimary)
                                                {
                                                    <i class="fa fa-star ms-1 text-warning"></i>
                                                }
                                                @if (sig.TemHistoria)
                                                {
                                                    <span class="position-absolute top-0 start-100 translate-middle p-1 bg-warning border border-light rounded-circle" title="Tem Mnemônico"></span>
                                                }
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="card shadow-sm border-0" style="background-color: #f8f9fa;">
                        <div class="card-header bg-white py-2"><strong><i class="fa fa-plus-circle text-vocab"></i> Nova Tradução</strong></div>
                        <div class="card-body p-3 border-top">
                            <form id="formNovaTraducao" onsubmit="salvarNovaTraducao(event)">
                                <input type="hidden" id="vocabId" name="vocabularyId" value="@Model.Id" />
                                <div class="row g-2">
                                    <div class="col-md-4"><select name="languageId" class="form-select form-select-sm" asp-items="Model.LinguasDisponiveis" asp-for="LinguaSelecionadaId"></select></div>
                                    <div class="col-md-5"><input type="text" name="meaning" class="form-control form-control-sm" placeholder="Digite a tradução..." required /></div>
                                    <div class="col-md-3 d-grid"><button type="submit" class="btn bg-vocab text-white btn-sm fw-bold">Salvar</button></div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 h-100">
                        <a data-bs-toggle="collapse" href="#collapseContexto" role="button" class="text-decoration-none text-dark">
                            <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                                <strong><i class="fa fa-quote-left"></i> Contexto</strong>
                                <span class="badge bg-secondary rounded-pill">@Model.Sentencas.Count <i class="fa fa-chevron-down text-white ms-1"></i></span>
                            </div>
                        </a>
                        <div class="collapse" id="collapseContexto">
                            <div class="card-body bg-white p-0 border-top" style="max-height: 200px; overflow-y: auto;">
                                <ul class="list-group list-group-flush">
                                    @foreach (var sentenca in Model.Sentencas)
                                    {
                                        <li class="list-group-item p-3">
                                            <p class="mb-1 fs-5 text-dark">@sentenca.Japones</p>
                                            <small class="text-muted"><i class="fa fa-language me-1"></i> @sentenca.Traducao</small>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="paneMnemonic" class="d-flex flex-column" style="width: 33.333%; padding-left: 15px; border-left: 1px solid #dee2e6;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-outline-secondary btn-sm" onclick="fecharPainelMnemonic()">
                        <i class="fa fa-arrow-left"></i> Voltar
                    </button>
                    <h5 class="m-0 fw-bold text-vocab" id="tituloMnemonic">História da Tradução</h5>
                    <div style="width: 70px;"></div>
                </div>

                <input type="hidden" id="currentMeaningId" />
                <input type="hidden" id="currentMnemonicId" />

                <div class="card shadow-sm flex-fill border-0">
                    <div class="card-body d-flex flex-column p-0">
                        <label class="fw-bold mb-2 px-1">Alvo: <span id="labelTraducao" class="text-primary fs-5"></span></label>

                        <div class="syntax-toolbar d-flex flex-wrap gap-1 p-2 bg-light border rounded-top">
                            <span class="small text-muted align-self-center me-2">Tags:</span>
                            @if (Model.ListaSyntax != null)
                            {
                                foreach (var item in Model.ListaSyntax)
                                {
                                    string estiloBtn = "border: 1px solid #ced4da;";
                                    if (!string.IsNullOrEmpty(item.TextColor)) estiloBtn += $"color: {item.TextColor};";
                                    if (!string.IsNullOrEmpty(item.BackgroundColor)) estiloBtn += $"background-color: {item.BackgroundColor}; border-color: {item.BackgroundColor};";
                                    if (item.IsBold) estiloBtn += "font-weight: bold;";
                                    if (item.IsItalic) estiloBtn += "font-style: italic;";
                                    if (item.IsUnderline) estiloBtn += "text-decoration: underline;";

                                    <button type="button" class="btn btn-sm border" style="@estiloBtn" onclick="inserirTagMnemonic('@item.Code')" title="@item.Description">
                                        @item.Code
                                    </button>
                                }
                            }
                        </div>

                        <textarea id="txtMnemonic" class="form-control mb-2" placeholder="Sua história vai aqui... Ex: O <k>Sol</k> é quente." style="min-height: 120px; resize: none; border-radius: 0 0 5px 5px; font-size: 1.1rem;" oninput="atualizarPreviewMnemonic()"></textarea>

                        <div class="card bg-light border-0 mb-3 flex-fill">
                            <div class="card-body py-2">
                                <small class="text-muted fw-bold text-uppercase" style="font-size: 0.7rem;">Preview:</small>
                                <div id="divMnemonicPreview" class="mt-1 fs-5 text-dark" style="min-height: 80px; overflow-y: auto;"></div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-auto pt-2 border-top">
                            <button id="btnExcluirMnemonic" class="btn btn-outline-danger d-none" onclick="excluirMnemonic()">
                                <i class="fa fa-trash"></i> Excluir
                            </button>
                            <button id="btnSalvarMnemonic" class="btn bg-vocab text-white fw-bold px-4 ms-auto" onclick="salvarMnemonic()">
                                <i class="fa fa-save"></i> Salvar como Principal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="paneReadings" class="d-flex flex-column" style="width: 33.333%; padding-left: 15px; border-left: 1px solid #dee2e6;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-outline-secondary btn-sm" onclick="fecharParaPrincipal()">
                        <i class="fa fa-arrow-left"></i> Voltar
                    </button>
                    <h5 class="m-0 fw-bold text-vocab">Gerenciar Leituras</h5>
                    <div style="width: 70px;"></div>
                </div>

                <div class="row flex-fill">
                    <div class="col-4 border-end" style="max-height: 400px; overflow-y: auto;">
                        <div class="list-group list-group-flush" id="listaReadingsVocab">
                            @foreach (var r in Model.ListaReadings)
                            {
                                <button type="button" id="btn-reading-@r.Id"
                                        class="list-group-item list-group-item-action py-3"
                                        onclick="selecionarReadingVocab(@r.Id, '@r.Reading', @(r.TemHistoria ? "true" : "false"), @(r.IsPrimary ? "true" : "false"))">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        <h5 class="mb-1 fw-bold text-primary">@r.Reading</h5>
                                        <i class="fa fa-star text-warning icon-star" style="display: @(r.IsPrimary ? "block" : "none");"></i>
                                    </div>
                                    <div class="icon-book text-success small mt-1" style="display: @(r.TemHistoria ? "block" : "none");">
                                        <i class="fa fa-book-open"></i> Tem história
                                    </div>
                                </button>
                            }
                        </div>
                    </div>

                    <div class="col-8">
                        <div id="msgSelecioneReadingVocab" class="text-center text-muted mt-5">
                            <i class="fa fa-hand-point-left fa-3x mb-3 opacity-25"></i>
                            <p>Selecione uma leitura para editar.</p>
                        </div>

                        <div id="areaEdicaoReadingVocab" style="display:none;" class="dflex flex-column h-100">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="text-primary fw-bold m-0">Editando: <span id="lblReadingSelecionadoVocab" class="text-dark fs-4">---</span></h6>
                                <button id="btnExcluirReadingVocab" class="btn btn-outline-danger btn-sm" onclick="excluirHistoriaReadingVocab()">
                                    <i class="fa fa-trash"></i> Excluir
                                </button>
                            </div>

                            <div class="syntax-toolbar d-flex flex-wrap gap-1 p-2 bg-light border rounded-top">
                                @if (Model.ListaSyntax != null)
                                {
                                    foreach (var item in Model.ListaSyntax)
                                    {
                                        string style = $"color:{item.TextColor};";
                                        if (!string.IsNullOrEmpty(item.BackgroundColor)) style += $"background-color:{item.BackgroundColor};";
                                        <button type="button" class="btn btn-sm border" style="@style" onclick="inserirTagReadingVocab('@item.Code')">@item.Code</button>
                                    }
                                }
                            </div>

                            <input type="hidden" id="hdnReadingIdVocab" />
                            <textarea id="txtEditorReadingVocab" class="form-control mb-2" placeholder="História da leitura..." style="min-height: 120px; resize: none; border-radius: 0 0 5px 5px;" oninput="atualizarPreviewReadingVocab()"></textarea>

                            <div class="card bg-light border-0 mb-3 flex-fill">
                                <div class="card-body py-2">
                                    <small class="text-muted fw-bold">Preview:</small>
                                    <div id="divPreviewReadingVocab" class="mt-1 fs-5 text-dark" style="min-height: 60px;"></div>
                                </div>
                            </div>

                            <button id="btnSalvarReadingVocab" class="btn bg-vocab text-white fw-bold w-100 mt-auto" onclick="salvarReadingBackendVocab()">
                                <i class="fa fa-save"></i> Salvar & Definir como Principal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="dadosSyntaxHighlight" value='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ListaSyntax.Select(s => new { code = s.Code, textColor = s.TextColor, bgColor = s.BackgroundColor, bold = s.IsBold, italic = s.IsItalic, underline = s.IsUnderline })))' />

        </div>
    </div>
</div>